<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitbit Workout Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="styles/style.css">
</head>

<body class="bg-light">
    <div class="container py-4">
        <h1>Fitbit Workout Dashboard</h1>
        <table id="workoutsTable">
            <thead>
                <tr>
                    <th>Activity</th>
                    <th>Start Time</th>
                    <th>Duration (min)</th>
                </tr>
            </thead>
            <tbody>
                <!-- Workouts listed here -->
            </tbody>
        </table>
        <div id="workoutSection" class="row d-flex align-items-stretch">
            <div id="workoutDetail" style="display:none;">
                <h2>Workout Details</h2>
                <hr>
                <div id="detailCard">
                    <p><strong>Workout ID:</strong> <span id="workoutID"></span></p>
                    <p><strong>Activity:</strong> <span id="activity"></span></p>
                    <p><strong>Date & Time:</strong> <span id="start"></span></p>
                    <p><strong>Duration:</strong> <span id="duration"></span> minutes</p>
                    <p><strong>Average HR:</strong> <span id="heartrate"></span> BPM</p>
                    <p><strong>Calories:</strong> <span id="calories"></span> kcal</p>
                    <p><strong>Steps:</strong> <span id="steps"></span></p>
                    <p><strong>Device:</strong> <span id="device"></span></p>
                </div>
            </div>

            <div id="reflectionForm" style="display:none;">
                <h2>Reflection</h2>
                <hr>
                <form id="reflection">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4>During Workout</h4>
                            <label>Mood:</label>
                            <div class="star-rating" data-name="mood">
                                <i class="bi bi-star" data-value="1"></i>
                                <i class="bi bi-star" data-value="2"></i>
                                <i class="bi bi-star" data-value="3"></i>
                                <i class="bi bi-star" data-value="4"></i>
                                <i class="bi bi-star" data-value="5"></i>
                            </div>
                            <input type="hidden" name="mood" value="0">
                            <label>Hydration:</label>
                            <div class="star-rating" data-name="hydration">
                                <i class="bi bi-star" data-value="1"></i>
                                <i class="bi bi-star" data-value="2"></i>
                                <i class="bi bi-star" data-value="3"></i>
                                <i class="bi bi-star" data-value="4"></i>
                                <i class="bi bi-star" data-value="5"></i>
                            </div>
                            <input type="hidden" name="hydration" value="0">
                            <label>Perceived Effort:</label>
                            <div class="star-rating" data-name="effort">
                                <i class="bi bi-star" data-value="1"></i>
                                <i class="bi bi-star" data-value="2"></i>
                                <i class="bi bi-star" data-value="3"></i>
                                <i class="bi bi-star" data-value="4"></i>
                                <i class="bi bi-star" data-value="5"></i>
                            </div>
                            <input type="hidden" name="effort" value="0">
                            <label>Satisfaction:</label>
                            <div class="star-rating" data-name="satisfaction">
                                <i class="bi bi-star" data-value="1"></i>
                                <i class="bi bi-star" data-value="2"></i>
                                <i class="bi bi-star" data-value="3"></i>
                                <i class="bi bi-star" data-value="4"></i>
                                <i class="bi bi-star" data-value="5"></i>
                            </div>
                            <input type="hidden" name="satisfaction" value="0">
                        </div>
                        <div>
                            <h4>After Workout</h4>
                            <label>Sleep Quality:</label>
                            <div class="star-rating" data-name="sleep">
                                <i class="bi bi-star" data-value="1"></i>
                                <i class="bi bi-star" data-value="2"></i>
                                <i class="bi bi-star" data-value="3"></i>
                                <i class="bi bi-star" data-value="4"></i>
                                <i class="bi bi-star" data-value="5"></i>
                            </div>
                            <input type="hidden" name="sleep" value="0">
                            <label>Fatigue:</label>
                            <div class="star-rating" data-name="fatigue">
                                <i class="bi bi-star" data-value="1"></i>
                                <i class="bi bi-star" data-value="2"></i>
                                <i class="bi bi-star" data-value="3"></i>
                                <i class="bi bi-star" data-value="4"></i>
                                <i class="bi bi-star" data-value="5"></i>
                            </div>
                            <input type="hidden" name="fatigue" value="0">
                            <label>Motivation for Next Workout:</label>
                            <div class="star-rating" data-name="motivation">
                                <i class="bi bi-star" data-value="1"></i>
                                <i class="bi bi-star" data-value="2"></i>
                                <i class="bi bi-star" data-value="3"></i>
                                <i class="bi bi-star" data-value="4"></i>
                                <i class="bi bi-star" data-value="5"></i>
                            </div>
                            <input type="hidden" name="motivation" value="0">
                            <label>Pain/Soreness:</label>
                            <div class="star-rating" data-name="pain">
                                <i class="bi bi-star" data-value="1"></i>
                                <i class="bi bi-star" data-value="2"></i>
                                <i class="bi bi-star" data-value="3"></i>
                                <i class="bi bi-star" data-value="4"></i>
                                <i class="bi bi-star" data-value="5"></i>
                            </div>
                            <input type="hidden" name="pain" value="0">
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button type="submit" class="btn">Submit Reflection</button>
                    </div>
                </form>
            </div>
        </div>
        <script>
            const workoutsTable = document.getElementById('workoutsTable').querySelector('tbody');
            const workoutDetail = document.getElementById('workoutDetail');
            const reflectionForm = document.getElementById('reflectionForm');

            let selectedWorkout = null;

            // Fetch last 10 workouts
            async function loadWorkouts() {
                const res = await fetch('http://localhost:3000/workouts');
                const data = await res.json();
                const workouts = data.activities.slice(0, 10);

                workoutsTable.innerHTML = '';
                workouts.forEach(w => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td>${w.activityName}</td>
                            <td>${new Date(w.startTime).toLocaleString()}</td>
                            <td>${Math.round(w.duration / 60000)}</td>
                        `;
                    tr.addEventListener('click', () => selectWorkout(w.logId));
                    workoutsTable.appendChild(tr);
                });
            }

            // Fetch single workout
            async function selectWorkout(logId) {
                const res = await fetch(`http://localhost:3000/workouts/${logId}`);
                const data = await res.json();
                selectedWorkout = data;

                resetStarRatings();

                setTimeout(() => {
                    document.getElementById('workoutSection').scrollIntoView({ behavior: 'smooth' });
                });

                workoutDetail.style.display = 'block';
                reflectionForm.style.display = 'block';
                document.getElementById('workoutSection').style.display = 'flex';

                document.getElementById('workoutID').textContent = data.logId;
                document.getElementById('activity').textContent = data.activityName;
                document.getElementById('start').textContent = new Date(data.startTime).toLocaleString();
                document.getElementById('duration').textContent = Math.round(data.duration / 60000);
                document.getElementById('heartrate').textContent = data.averageHeartRate || 'N/A';
                document.getElementById('calories').textContent = data.calories || 'N/A';
                document.getElementById('steps').textContent = data.steps || 'N/A';
                document.getElementById('device').textContent = data.source?.name || "Unknown";
            }

            // Handle reflection form
            document.getElementById('reflection').addEventListener('submit', (e) => {
                e.preventDefault();
                const mood = document.getElementById('mood').value;
                const hydration = document.getElementById('hydration').value;
                const effort = document.getElementById('effort').value;
                const satisfaction = document.getElementById('satisfaction').value;
                const sleep = document.getElementById('sleep').value;
                const fatigue = document.getElementById('fatigue').value;
                const motivation = document.getElementById('motivation').value;
                const pain = document.getElementById('pain').value;


                // Currently just logging in console
                console.log({
                    workoutLogId: selectedWorkout.logId,
                    mood,
                    hydration,
                    effort,
                    satisfaction,
                    sleep,
                    fatigue,
                    motivation,
                    data: selectedWorkout
                });

                alert('Reflection submitted! (in console)');
            });

            const starRatingResets = [];

            function resetStarRatings() {
                document.querySelectorAll('.star-rating').forEach(container => {
                    const stars = container.querySelectorAll('i');
                    const hiddenInput = container.nextElementSibling;

                    hiddenInput.value = 0;

                    stars.forEach(star => {
                        star.classList.remove('filled', 'bi-star-fill');
                        star.classList.add('bi-star');
                    });
                });

                starRatingResets.forEach(resetFn => resetFn());
            }

            document.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('.star-rating').forEach(container => {
                    const stars = container.querySelectorAll('i');
                    const hiddenInput = container.nextElementSibling;
                    let selectedValue = 0;

                    starRatingResets.push(() => {
                        selectedValue = 0;
                    });

                    function highlight(value) {
                        stars.forEach(star => {
                            if (parseInt(star.dataset.value) <= value) {
                                star.classList.add('filled');
                                star.classList.remove('bi-star');
                                star.classList.add('bi-star-fill');
                            } else {
                                star.classList.remove('filled');
                                star.classList.remove('bi-star-fill');
                                star.classList.add('bi-star');
                            }
                        });
                    }

                    stars.forEach(star => {
                        const value = parseInt(star.dataset.value);

                        star.addEventListener('mouseenter', () => {
                            highlight(value);
                        });

                        star.addEventListener('click', () => {
                            selectedValue = value;
                            hiddenInput.value = value;
                            highlight(value);
                        });
                    });

                    container.addEventListener('mouseleave', () => {
                        highlight(selectedValue);
                    });
                });
            });

            loadWorkouts();
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    </div>
</body>

</html>